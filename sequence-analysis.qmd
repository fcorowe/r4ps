# Sequence Analysis {#sec-chp4}

## Dependencies

```{r}
#| include = FALSE
rm(list=ls())
```


```{r}
#| warning: false

# load package
library(wpgpDownloadR)

library(terra)
library(stars)
library(sf)

library(tidyverse)

library(viridis)
library(RColorBrewer)


```

## Data

Aim: to define trajectories of population decline or ageing

Data source: WorldPop 2000-2020

See list of countries 
```{r}
wpgpListCountries()
```
Data sets available for Ukraine
```{r}
wpgpListCountryDatasets(ISO3 = "UKR")
```
Obtain population data for Ukraine 2000
```{r}
pop2000_raster <- read_stars("./data/sequence-analysis/ukr_ppp_2000_1km_Aggregated.tif")

pop2000_raster

plot(pop2000_raster)
```



```{r}
# pop2000_df <- wpgpGetPOPTable(ISO3 = "UKR", 
#                       year = 2000)
# pop2000_df
```

We need administrative boundaries in the form of polygons

```{r}
ukr_shp <- st_read("./data/sequence-analysis/ukr_shp/gadm41_UKR_2.shp") %>% 
  st_simplify(., 
              preserveTopology = T,
              dTolerance = 1000) %>%  # 1km
  sf::st_make_valid(.) %>% 
  fortify(.) %>% 
  st_transform(., "EPSG:4326")

ukr_shp
```

```{r}
plot(ukr_shp$geometry)
```




```{r}
pop2000_raster <- st_transform(pop2000_raster, st_crs(ukr_shp))
```


```{r}
system.time({

popbyarea_df = aggregate(x = pop2000_raster, 
                                   by = ukr_shp, 
                                   FUN = sum, 
                                   na.rm = TRUE) 
})

```


```{r}
ukr_eshp <- mutate(ukr_shp, population = popbyarea_df$ukr_ppp_2000_1km_Aggregated.tif)

ukr_eshp

sum(ukr_eshp$population, na.rm = TRUE)
```





Aggregate population counts by administrative area
```{r}

```








### Data Wrangling

Exploratory data analysis to understand the data - time-space data

## Application

Explain intuition and main steps

### Defining outcome process

Define the thresholds that should be used to define the extent / pace of acceleration.

### Optimal matching

Computation of distance - intuition \> indel operators \> different OM algorithms \> use optimal matching

### Clustering

Different cluster algorithms - use of k-meloids

Determining the number of clusters

### Visualising

Individual trajectories

Frequency plots

Time spent

Top ten trajectories

## Questions

Francisco to write

This chapter shows the use of sequence analysis to study population decline and draw on the following papers:

-   @rowe2022a

-   @newsham2022a

-   @rowe2022b
